---
version: 2
plan:
  project-key: RE
  key: RECIC
  name: ContentIndexClient
stages:
  - Build:
      - Create package and run tests

Create package and run tests:
  tasks:
    - script: |
        rm -rf code &&
        mkdir -p code &&
        (mv * .* code/ || true) &&

        cd code &&
        rm -rf .git &&
        tar czvf ../recontentindexclient.tar.gz ./ &&
        php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');" &&
        php composer-setup.php &&
        php -r "unlink('composer-setup.php');" &&
        php composer.phar install &&

        vendor/bin/phpunit -c phpunit.xml --log-junit test-report.xml
  artifacts:
    - name: recontentindexclient.tar.gz
      location: ./
      pattern: recontentindexclient.tar.gz
      required: true
      shared: true
  final-tasks:
    - test-parser:
        type: junit
        test-results: code/test-report.xml
  requirements:
    - platform: ubuntu1804
